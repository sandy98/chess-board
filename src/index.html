<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0">
  <title>Chess Board Web Component</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon"/>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"/>
  <script src="/build/chessboard.js"></script>
  <style>
    .up-and-down {
      display: flex;
      flex-direction: row;
      justify-content:space-between;
      align-items: center;
      margin-top: 10px;
      margin-bottom: 10px;
      color: steelblue;
    }
  </style>
</head>
<body>
  <div
    style="display: flex; 
           padding: 1rem; 
           flex-direction: row; 
           justify-content: space-between; 
           align-items: flex-start; 
           border: solid 1px; 
           margin-top: 30px; 
           border-radius: 0;
           height: 90%;
           min-height: 90%;
           max-height: 90%;"
  >
    <div style="width: 60%;">
      <chess-board>
        <div slot="external-contents">
          <div style="margin-bottom: 0.5rem; 
                      color:chocolate; 
                      flex-direction: column;
                      display: flex; 
                      justify-content: center; 
                      align-items: center;
                      padding: 0.5rem;"
          >
            ChessBoard <hr/>by Domingo E. Savoretti <hr/>powered by Stencil.js<br/>
          </div>
          <div style="width: 95%;
                      display: flex; 
                      flex-direction: column; 
                      justify-content: space-evenly;
                      align-items:center;
                      border: solid 1px silver; 
                      border-radius: 0;
                      padding: 0.5rem;
                      margin-left: 0;"
          >
            <div class="up-and-down">
              <button onclick="document.querySelector('chess-board').flip()">Flip Board</button>
            </div>
            <div class="up-and-down">
              <label for="chess-sets">
                Select chess set
                &nbsp;&nbsp;&nbsp;
                <select id="chess-sets">
                </select>
              </label>
            </div>
            <div class="up-and-down">
                <label for="board-schemas">Select color schema</label>
                &nbsp;&nbsp;&nbsp;
                <select id="board-schemas">
              </select>
            </div>
            <div class="up-and-down">
              <div class="up-and-down">
                <label style="font-size: 12px">Select figure for automatic promotion</label>
              </div>
              <div style="background: beige; cursor: pointer;">
                  <button id="no-autoprom" onclick = "document.querySelector('chess-board').autoPromotion = ''; setPrBg();">None</button>
                </div>
              <div style="background: beige; cursor: pointer;" onclick = "document.querySelector('chess-board').autoPromotion = 'Q'; setPrBg();">
                <img id="img-q" style="width:32px; height: 32px;"/>
              </div>
              <div style="background: beige; cursor: pointer;" onclick = "document.querySelector('chess-board').autoPromotion = 'R'; setPrBg();">
                  <img id="img-r" style="width:32px; height: 32px;" />
              </div>
              <div style="background: beige; cursor: pointer;" onclick = "document.querySelector('chess-board').autoPromotion = 'N'; setPrBg();">
                <img id="img-n" style="width:32px; height: 32px;" />
              </div>
              <div style="background: beige; cursor: pointer;" onclick = "document.querySelector('chess-board').autoPromotion = 'B'; setPrBg();">
                  <img id="img-b" style="width:32px; height: 32px;" />
              </div>
            </div>
            <div class="up-and-down">
              <label>Navigate game&nbsp;&nbsp;&nbsp;</label>
              <button onclick="goto(0)">&lt;&lt;</button>&nbsp;
              <button onclick="goto(-1)">&lt;</button>&nbsp;
              <button onclick="goto(1)">&gt;</button>&nbsp;
              <button onclick="goto(1000)">&gt;&gt;</button>
            </div>
            <div class="up-and-down">
              <!--<button onclick="document.querySelector('chess-board').reset()">Reset Board</button>
              &nbsp;&nbsp;&nbsp;
              <button onclick="document.querySelector('chess-board').empty()">Empty Board</button>
              &nbsp;&nbsp;&nbsp;-->
              <button onclick="document.querySelector('chess-board').setup()">Setup Board</button>
            </div>
          </div>      
         </div>
        </div>
      </chess-board>  
  </div>
  <div style="border: solid 1px transparent; margin-top: 0.5rem;">
    <button onclick="board.togglePanel()">Toggle board panel</button>
  </div>
  <script type="text/javascript">
    let currPos = 0

    const capitalize = function(word) {
      let arr = word.split('');
      arr = arr.map((ch) => ch.toLowerCase());
      arr[0] = arr[0].toUpperCase();
      return arr.join('');
    }

    const goto = function(n) {
      let max = this.board.getLength()
      if (n < -1) currPos = 0
      if (n >= max) currPos = max - 1
      if (n === 0) currPos = 0
      if (n === 1) currPos++
      if (n === -1) currPos--
      if (currPos < 0) currPos = 0
      if (currPos >= max) currPos = max - 1
      this.board.goto(currPos)
    }

    const setPrBg = function() {
      document.querySelector('#no-autoprom').disabled = !board.autoPromotion
      document.querySelector('#img-q').style.background = board.autoPromotion === 'Q' ? board.darkBg : board.lightBg;
      document.querySelector('#img-r').style.background = board.autoPromotion === 'R' ? board.darkBg : board.lightBg;
      document.querySelector('#img-n').style.background = board.autoPromotion === 'N' ? board.darkBg : board.lightBg;
      document.querySelector('#img-b').style.background = board.autoPromotion === 'B' ? board.darkBg : board.lightBg;
    }

    const onselectchange = function(ev) {
      ev.preventDefault();
      console.log(`Set changed to ${ev.target.value}`);
      document.querySelector("chess-board").selectSet(ev.target.value);
      return true;
    }

    const onselectSchemachange = function(ev) {
      ev.preventDefault();
      //console.log(`Set changed to ${ev.target.value}`);
      document.querySelector("chess-board").setSchema(ev.target.selectedIndex);
      setPrBg();
      return true;
    }

    const loadselector = function() {
      console.log("Initializing chess sets selection");
      
      const board = document.querySelector("chess-board");
      window.board = board;
      board.setSchema(1)

      const selectSet = document.querySelector("#chess-sets");
      for (k in board.sets) {
        let opt = document.createElement('option');
        opt.value = k;
        opt.innerHTML = capitalize(k);
        selectSet.appendChild(opt);
      }


      selectSet.value = board.chessSet;
      selectSet.onchange = onselectchange;


      const selectSchema = document.querySelector("#board-schemas");
      let i = 0
      for (k in board.schemas) {
        let opt = document.createElement('option');
        opt.value = k
        opt.innerHTML = capitalize(k);
        selectSchema.appendChild(opt);
      }
      selectSchema.selectedIndex = 1;
      selectSchema.onchange = onselectSchemachange;

      document.querySelector('#img-q').src = board.sets[board.chessSet]['Q']
      document.querySelector('#img-r').src = board.sets[board.chessSet]['R']
      document.querySelector('#img-n').src = board.sets[board.chessSet]['N']
      document.querySelector('#img-b').src = board.sets[board.chessSet]['B']

      setPrBg()

      document.addEventListener('newMove', (ev) => {
        console.log(`Received new move from chessboard: from = ${ev.detail.from}, to = ${ev.detail.to} originated in ${ev.target}`)
        currPos = board.getLength() -1
      })

      document.addEventListener('changeCurrent', (ev) => {
        console.log('changeCurrent event: ' + ev.detail)
        currPos = ev.detail
      }) 
      
    }

    document.addEventListener('load', loadselector);
    document.body.onload = loadselector;
  </script>
</body>
</html>
